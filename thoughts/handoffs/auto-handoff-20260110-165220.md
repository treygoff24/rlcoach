# Auto-Handoff â€” 20260110-165220

**Project:** rlcoach
**Generated:** 2026-01-10 16:52:20

---

## Current Context

# Project Context â€” DO NOT DELETE

**Last Updated**: Phase 1 - SaaS Fixes (IN PROGRESS)

## Protocol Reminder (Re-read on every phase start)

**The Loop**: IMPLEMENT â†’ TYPECHECK â†’ LINT â†’ BUILD â†’ TEST â†’ REVIEW â†’ FIX â†’ SLOP REMOVAL â†’ COMMIT

**Quality gates:**
```bash
source .venv/bin/activate
PYTHONPATH=src pytest -q
ruff check src/
black --check src/
```

**If context feels stale:** Re-read `AUTONOMOUS_BUILD_CLAUDE.md` for the full protocol.

## Build Context

**Type**: Critical bug fixes for SaaS launch
**Plan location**: `SAAS_FIXES_PLAN.md`
**Source**: Codex code review (2026-01-06)

## Current Phase: Phase 1 - Fix DB Initialization

Fixing database initialization to work with DATABASE_URL in SaaS mode.

## Project Setup

- Framework: Next.js 14 + FastAPI + PostgreSQL
- Styling: Tailwind CSS (dark mode)
- State: React hooks + server state
- Database: PostgreSQL via SQLAlchemy
- Queue: Celery + Redis
- Testing: pytest (388 tests)

## Critical Issues Being Fixed

1. **DB init** - app.py ignores DATABASE_URL, tries local config
2. **Auth** - Users not created in Postgres on OAuth login
3. **Replay persistence** - Worker doesn't persist to Replay/PlayerGameStats
4. **Schema drift** - Endpoints reference non-existent columns
5. **Mock data** - Dashboard pages use hardcoded data

## Key Files

- `src/rlcoach/api/app.py` - FastAPI app, lifespan handler
- `src/rlcoach/api/auth.py` - JWT validation middleware
- `src/rlcoach/worker/tasks.py` - Celery tasks for replay processing
- `src/rlcoach/db/writer.py` - Database writer for analysis results
- `src/rlcoach/db/models.py` - SQLAlchemy models
- `frontend/src/lib/auth.ts` - NextAuth configuration

## Schema Notes

- `bcpm` = boost consumed per minute (NOT boost_per_minute)
- `time_supersonic_s` = supersonic time in seconds (NOT supersonic_pct)
- Win/loss stored as uppercase: "WIN", "LOSS", "DRAW"

## API Contracts

### POST /api/v1/users/bootstrap
Creates user on first login
```json
Request: { "provider": "discord", "providerId": "123", "email": "...", "name": "..." }
Response: { "id": "uuid", "subscriptionTier": "free" }
```

### GET /api/v1/replays
Returns user's replays
```json
Response: { "replays": [...], "total": 42, "page": 1 }
```

## Design Decisions

- DATABASE_URL takes precedence over config file
- SAAS_MODE=true excludes CLI routers
- Users created via bootstrap endpoint on first OAuth login
- Replay persistence uses existing db/writer.py

## 196 Test Replays Available

Located in `/replays/` directory for testing the full pipeline.

---

## Git State

**Branch:** `main`

**Uncommitted Changes:**
```
 M .DS_Store
?? thoughts/handoffs/auto-handoff-20260110-144710.md
```

**Recent Commits:**
```
dd831a6    1 fix: seed script identity config and display name extraction    2    3 - Add identity config for marking is_me on player stats    4 - Exclude replays with empressolive (wife's account)    5 - Fix display_name extraction (was using "name" but report uses "display_name")    6    7 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)    8    9 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
9484fb6    1 fix: use consistent dev-user-123 ID for dev-login bootstrap    2    3 - Bootstrap endpoint now preserves provider_account_id as user ID for dev-login    4 - Dev users automatically get "pro" subscription tier    5 - Fixes ID mismatch between dev-login and seed script    6    7 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)    8    9 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
330bf29    1 feat: wire dashboard trends and compare pages to real APIs    2    3 Backend:    4 - Add /me/trends endpoint for user-specific trend data (SaaS-safe)    5 - Add /me/compare/self endpoint for period-over-period comparison    6 - Fix zero-value handling (0 goals was incorrectly treated as null)    7 - Fix has_data flag (was true even with empty values)    8    9 Frontend:   10 - Trends page: switch from disabled /analysis/trends to /users/me/trends   11 - Compare page: complete rewrite from mock data to real API calls   12   - Rank tab: uses /users/me/benchmarks   13   - Self tab: uses /users/me/compare/self   14   - Added loading states, error states, empty states   15   16 Docs:   17 - Add gaps audit documenting spec vs implementation status   18 - Add implementation plan (mostly historical - Gemini review found   19   most features already implemented, only trends/compare were gaps)   20   21 417 tests pass, frontend builds   22   23 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   24   25 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
3cbd70c    1 fix: complete dev-login support for credentials provider    2    3 - Default login redirect to /replays instead of /    4 - Handle undefined providerAccountId for credentials providers    5 - Add dev-login to allowed bootstrap providers    6 - Add seed_dev_replays.py script for test data    7 - Add tsconfig.tsbuildinfo to gitignore    8    9 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   10   11 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
50e3a44    1 fix: dev login auth for NextAuth v5 credentials provider    2    3 - Replace getToken() with auth() in API proxy route (NextAuth v5 pattern)    4 - Use session.accessToken instead of creating JWT in route handler    5 - Remove rewrites() that bypassed the auth-attaching route handler    6 - Fix run-backend-dev.sh script (had embedded line numbers)    7    8 The rewrites() rule was intercepting /api/v1/* requests at the routing    9 layer before they reached the route handler, bypassing JWT attachment.   10   11 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   12   13 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

---

## Resume Instructions

1. Re-read this handoff
2. Re-read CONTEXT.md if it exists
3. Check the implementation plan for current phase
4. Continue from where you left off

*Auto-generated before context compaction.*
