# Auto-Handoff â€” 20260110-144710

**Project:** rlcoach
**Generated:** 2026-01-10 14:47:10

---

## Current Context

# Project Context â€” DO NOT DELETE

**Last Updated**: Phase 1 - SaaS Fixes (IN PROGRESS)

## Protocol Reminder (Re-read on every phase start)

**The Loop**: IMPLEMENT â†’ TYPECHECK â†’ LINT â†’ BUILD â†’ TEST â†’ REVIEW â†’ FIX â†’ SLOP REMOVAL â†’ COMMIT

**Quality gates:**
```bash
source .venv/bin/activate
PYTHONPATH=src pytest -q
ruff check src/
black --check src/
```

**If context feels stale:** Re-read `AUTONOMOUS_BUILD_CLAUDE.md` for the full protocol.

## Build Context

**Type**: Critical bug fixes for SaaS launch
**Plan location**: `SAAS_FIXES_PLAN.md`
**Source**: Codex code review (2026-01-06)

## Current Phase: Phase 1 - Fix DB Initialization

Fixing database initialization to work with DATABASE_URL in SaaS mode.

## Project Setup

- Framework: Next.js 14 + FastAPI + PostgreSQL
- Styling: Tailwind CSS (dark mode)
- State: React hooks + server state
- Database: PostgreSQL via SQLAlchemy
- Queue: Celery + Redis
- Testing: pytest (388 tests)

## Critical Issues Being Fixed

1. **DB init** - app.py ignores DATABASE_URL, tries local config
2. **Auth** - Users not created in Postgres on OAuth login
3. **Replay persistence** - Worker doesn't persist to Replay/PlayerGameStats
4. **Schema drift** - Endpoints reference non-existent columns
5. **Mock data** - Dashboard pages use hardcoded data

## Key Files

- `src/rlcoach/api/app.py` - FastAPI app, lifespan handler
- `src/rlcoach/api/auth.py` - JWT validation middleware
- `src/rlcoach/worker/tasks.py` - Celery tasks for replay processing
- `src/rlcoach/db/writer.py` - Database writer for analysis results
- `src/rlcoach/db/models.py` - SQLAlchemy models
- `frontend/src/lib/auth.ts` - NextAuth configuration

## Schema Notes

- `bcpm` = boost consumed per minute (NOT boost_per_minute)
- `time_supersonic_s` = supersonic time in seconds (NOT supersonic_pct)
- Win/loss stored as uppercase: "WIN", "LOSS", "DRAW"

## API Contracts

### POST /api/v1/users/bootstrap
Creates user on first login
```json
Request: { "provider": "discord", "providerId": "123", "email": "...", "name": "..." }
Response: { "id": "uuid", "subscriptionTier": "free" }
```

### GET /api/v1/replays
Returns user's replays
```json
Response: { "replays": [...], "total": 42, "page": 1 }
```

## Design Decisions

- DATABASE_URL takes precedence over config file
- SAAS_MODE=true excludes CLI routers
- Users created via bootstrap endpoint on first OAuth login
- Replay persistence uses existing db/writer.py

## 196 Test Replays Available

Located in `/replays/` directory for testing the full pipeline.

---

## Git State

**Branch:** `main`

**Uncommitted Changes:**
```
 M src/rlcoach/api/routers/users.py
?? docs/DASHBOARD_FIX_PLAN.md
?? docs/GAPS_AUDIT.md
```

**Recent Commits:**
```
3cbd70c    1 fix: complete dev-login support for credentials provider    2    3 - Default login redirect to /replays instead of /    4 - Handle undefined providerAccountId for credentials providers    5 - Add dev-login to allowed bootstrap providers    6 - Add seed_dev_replays.py script for test data    7 - Add tsconfig.tsbuildinfo to gitignore    8    9 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   10   11 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
50e3a44    1 fix: dev login auth for NextAuth v5 credentials provider    2    3 - Replace getToken() with auth() in API proxy route (NextAuth v5 pattern)    4 - Use session.accessToken instead of creating JWT in route handler    5 - Remove rewrites() that bypassed the auth-attaching route handler    6 - Fix run-backend-dev.sh script (had embedded line numbers)    7    8 The rewrites() rule was intercepting /api/v1/* requests at the routing    9 layer before they reached the route handler, bypassing JWT attachment.   10   11 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   12   13 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
5015ad9    1 fix: security and performance fixes in replays API    2    3 Security fixes (found by Codex & Gemini code review):    4 - Cross-user metadata leak: filter UploadedReplay by user_id    5 - Symlink attack vector: use secure user-specific upload directory    6 - Async blocking I/O: use run_in_executor for file operations    7    8 Performance fixes:    9 - Memory optimization: stream uploads, read only header for validation   10 - SQL optimization: use GROUP BY instead of Python aggregation   11   12 New:   13 - 11 security regression tests   14 - CLI agents reference doc (Codex & Gemini headless usage)   15   16 417 tests pass, lint clean   17   18 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   19   20 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
0027dae    1 feat: add dev login bypass and Hetzner deployment guide    2    3 - Dev login: credentials provider for local testing (dev mode only)    4 - Orange "Dev Login" button on login page skips OAuth    5 - Hetzner deployment guide with Docker Compose setup    6    7 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)    8    9 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
1056831    1 fix: address code review findings from Codex and Gemini    2    3 Critical fixes:    4 - Rust parser: unwrap_or(true) to keep unclassified actors (fixes empty players)    5 - GDPR: prefix steam:/epic: to match DB storage format    6 - Docker: remove non-existent setup.py, add UPLOAD_DIR/BACKEND_URL    7 - NextAuth: add jose JWT creation for backend API auth    8    9 Improvements:   10 - Worker: add completed_partial status for failed persistence   11 - Makefile: use absolute VENV_BIN path for Rust builds   12 - Coach tools: add .upper() fallback for non-core playlists   13 - Passing threshold: 80 -> 200 UU per documented spec   14 - Kickoffs: remove dead GOAL_FOR/GOAL_AGAINST code   15   16 New tests:   17 - 12 GDPR unit tests for ID prefixing and validation   18   19 406 tests pass, lint clean, frontend builds   20   21 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   22   23 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

---

## Resume Instructions

1. Re-read this handoff
2. Re-read CONTEXT.md if it exists
3. Check the implementation plan for current phase
4. Continue from where you left off

*Auto-generated before context compaction.*
