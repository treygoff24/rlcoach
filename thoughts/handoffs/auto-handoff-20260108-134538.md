# Auto-Handoff â€” 20260108-134538

**Project:** rlcoach
**Generated:** 2026-01-08 13:45:38

---

## Current Context

# Project Context â€” DO NOT DELETE

**Last Updated**: Phase 1 - SaaS Fixes (IN PROGRESS)

## Protocol Reminder (Re-read on every phase start)

**The Loop**: IMPLEMENT â†’ TYPECHECK â†’ LINT â†’ BUILD â†’ TEST â†’ REVIEW â†’ FIX â†’ SLOP REMOVAL â†’ COMMIT

**Quality gates:**
```bash
source .venv/bin/activate
PYTHONPATH=src pytest -q
ruff check src/
black --check src/
```

**If context feels stale:** Re-read `AUTONOMOUS_BUILD_CLAUDE.md` for the full protocol.

## Build Context

**Type**: Critical bug fixes for SaaS launch
**Plan location**: `SAAS_FIXES_PLAN.md`
**Source**: Codex code review (2026-01-06)

## Current Phase: Phase 1 - Fix DB Initialization

Fixing database initialization to work with DATABASE_URL in SaaS mode.

## Project Setup

- Framework: Next.js 14 + FastAPI + PostgreSQL
- Styling: Tailwind CSS (dark mode)
- State: React hooks + server state
- Database: PostgreSQL via SQLAlchemy
- Queue: Celery + Redis
- Testing: pytest (388 tests)

## Critical Issues Being Fixed

1. **DB init** - app.py ignores DATABASE_URL, tries local config
2. **Auth** - Users not created in Postgres on OAuth login
3. **Replay persistence** - Worker doesn't persist to Replay/PlayerGameStats
4. **Schema drift** - Endpoints reference non-existent columns
5. **Mock data** - Dashboard pages use hardcoded data

## Key Files

- `src/rlcoach/api/app.py` - FastAPI app, lifespan handler
- `src/rlcoach/api/auth.py` - JWT validation middleware
- `src/rlcoach/worker/tasks.py` - Celery tasks for replay processing
- `src/rlcoach/db/writer.py` - Database writer for analysis results
- `src/rlcoach/db/models.py` - SQLAlchemy models
- `frontend/src/lib/auth.ts` - NextAuth configuration

## Schema Notes

- `bcpm` = boost consumed per minute (NOT boost_per_minute)
- `time_supersonic_s` = supersonic time in seconds (NOT supersonic_pct)
- Win/loss stored as uppercase: "WIN", "LOSS", "DRAW"

## API Contracts

### POST /api/v1/users/bootstrap
Creates user on first login
```json
Request: { "provider": "discord", "providerId": "123", "email": "...", "name": "..." }
Response: { "id": "uuid", "subscriptionTier": "free" }
```

### GET /api/v1/replays
Returns user's replays
```json
Response: { "replays": [...], "total": 42, "page": 1 }
```

## Design Decisions

- DATABASE_URL takes precedence over config file
- SAAS_MODE=true excludes CLI routers
- Users created via bootstrap endpoint on first OAuth login
- Replay persistence uses existing db/writer.py

## 196 Test Replays Available

Located in `/replays/` directory for testing the full pipeline.

---

## Git State

**Branch:** `main`

**Uncommitted Changes:**
```
 M .DS_Store
 M Makefile
 M backend/Dockerfile
 M docker-compose.yml
 M frontend/src/lib/auth.ts
 M frontend/src/middleware.ts
 M parsers/rlreplay_rust/src/lib.rs
 M src/rlcoach/analysis/insights.py
 M src/rlcoach/analysis/kickoffs.py
 M src/rlcoach/analysis/passing.py
 M src/rlcoach/api/routers/analysis.py
 M src/rlcoach/api/routers/billing.py
 M src/rlcoach/api/routers/coach.py
 M src/rlcoach/api/routers/games.py
 M src/rlcoach/api/routers/gdpr.py
 M src/rlcoach/api/routers/players.py
 M src/rlcoach/api/security.py
 M src/rlcoach/db/models.py
 M src/rlcoach/db/writer.py
 M src/rlcoach/services/coach/budget.py
```

**Recent Commits:**
```
3b135c8 fix: restore replay/session flows
9f4131e    1 feat: SaaS fixes - auth, APIs, dashboard wiring    2    3 - Bootstrap endpoint: HMAC signature verification    4 - Replays API: analysis endpoint, sessions endpoint, result/score fields    5 - Dashboard pages: wired to real APIs (replays, sessions, replay detail)    6 - Worker: fixed replay_id extraction from root level    7 - Frontend auth: signature computation for bootstrap    8    9 394 tests pass, lint clean, frontend builds   10   11 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   12   13 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
06039a2    1 fix(frontend): correct routing paths for dashboard links    2    3 Next.js route groups like (dashboard) don't add segments to URL paths.    4 All internal links incorrectly used /dashboard/... which resulted in 404s.    5    6 Fixed hrefs in:    7 - Sidebar.tsx: All nav items (/, /replays, /sessions, etc.)    8 - page.tsx: Empty state CTA, quick action cards    9 - replays/page.tsx: Replay row links   10 - sessions/page.tsx: Session card links   11 - UploadDropzone.tsx: View replay after upload   12   13 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   14   15 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
649da02 docs: update CONTEXT.md with UX polish sprint summary
9dc8991    1 fix(security): address code review findings    2    3 1. Trends API period validation:    4    - Add explicit allowlist {"7d", "30d", "90d", "all"}    5    - Reject invalid periods with 400 error (prevents ValueError)    6    7 2. Trends API data leakage fix:    8    - Unauthenticated requests now return empty array    9    - Prevents leakage of is_me data across all users   10    - CLI users should use --token for auth   11   12 3. Benchmarks rate limiting:   13    - Add "benchmarks" rate limit (30 req/min)   14    - Prevents abuse of expensive aggregation queries   15   16 Also fixed:   17 - Removed unused `key` variable in rate_limit.py   18 - Auto-fixed import ordering in users.py (ruff)   19   20 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   21   22 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

---

## Resume Instructions

1. Re-read this handoff
2. Re-read CONTEXT.md if it exists
3. Check the implementation plan for current phase
4. Continue from where you left off

*Auto-generated before context compaction.*
