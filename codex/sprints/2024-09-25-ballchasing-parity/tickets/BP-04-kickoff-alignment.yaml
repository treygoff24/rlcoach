title: "[rlcoach] Fix kickoff detection and touch sequencing for parity"
type: bugfix
priority: P1
branch: "feature/bp-04-kickoff-alignment"
repo:
  url: https://github.com/treygoff/rlcoach
  root: .
  paths_in_scope:
    - src/rlcoach/events.py
    - src/rlcoach/analysis/kickoffs.py
    - src/rlcoach/analysis/passing.py
    - tests/analysis/**
  paths_out_of_scope:
    - src/rlcoach/analysis/movement.py
    - src/rlcoach/analysis/boost.py
context:
  stack: {lang: Python, framework: pytest, runtime: Python 3.10}
  versions: {pytest: "7.x"}
  style_guides: ["codex/docs/gpt5-codex-ticketing-guide.md", "codex/docs/gpt5-prompting-best-practices-guide.md"]
  related_issues: ["codex/sprints/2024-09-25-ballchasing-parity/tickets/BP-01-parity-harness.yaml"]
problem_statement: >
  Kickoff metrics (first possession, kickoff counts, time-to-first-touch) and early touch sequences are inaccurate,
  producing glaring parity failures. Update kickoff state tracking, first possession heuristics, and touch ordering so
  parity tests reflect Ballchasing outcomes.
non_goals:
  - Do not tune boost or movement analyzers here.
  - Do not implement rotation compliance adjustments.
constraints:
  - Kickoff detection must remain robust for OT and irregular game states.
  - Touch ordering changes must preserve downstream passing analyzer behavior.
  - Time-to-first-touch should be calculated using normalized frame timestamps with documented tolerance.
artifacts_expected:
  output_mode: diff
  pr_title_template: "[kickoffs] Align kickoff outcomes and touch sequencing"
  pr_body_sections: ["Context", "Implementation", "Tests", "Risks", "Follow-ups"]
  decision_log: true
acceptance_criteria:
  - [ ] Parity harness reports kickoff metrics within ±1 count and ±0.1 s for time-to-first-touch vs Ballchasing on the 0925 replay.
  - [ ] Kickoff events capture first-possession winner and kickoff goals using updated heuristics.
  - [ ] Touch sequencing supports consistent possession tracking, verified by updated unit tests.
  - [ ] Document the refined kickoff/touch logic in plan or inline comments referencing thresholds.
verification:
  repro_steps: |
    python -m rlcoach.cli report-md Replay_files/0925.replay --out out --pretty
  checks:
    - cmd: "pytest tests/analysis/test_ballchasing_parity.py -q"
    - cmd: "pytest tests/analysis/test_kickoffs.py -q"
workflow_expectations:
  - plan-first
  - implement
  - self-check
  - emit_patch
  - run_verification
  - summarize
codex:
  approvals: on-request
  sandbox: workspace-write
  web_search: false
  progress: brief
  review:
    ask_for_diff_format: unified
  agents_md: true
